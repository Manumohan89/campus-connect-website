const ExcelJS = require('exceljs');
const pool = require('../db');

function cleanData(value) {
  if (value === null || value === undefined) {
    return 0;
  }
  const cleanedValue = parseInt(value.toString().replace(/[^0-9]/g, ''), 10);
  return isNaN(cleanedValue) ? 0 : cleanedValue;
}

function convertToGradePoints(totalMarks) {
  if (totalMarks >= 90) return 10;
  if (totalMarks >= 80) return 9;
  if (totalMarks >= 70) return 8;
  if (totalMarks >= 60) return 7;
  if (totalMarks >= 50) return 6;
  if (totalMarks >= 40) return 5;
  return 0;
}

function getCreditsForSubject(subjectCode) {
  const creditsMap = {
    // 2021 Scheme: Semester I (Physics and Chemistry Cycles)
    '21MAT11': 3,
    '21PHY12': 3,
    '21ELE13': 3,
    '21CIV14': 3,
    '21EVN15': 3,
    '21PHYL16': 1,
    '21ELEL17': 1,
    '21EGH18': 2,
    '21IDT19': 1,
    '21SFH19': 1,
    '21CHE12': 3,
    '21PSP13': 3,
    '21ELN14': 3,
    '21EME15': 3,
    '21CHEL16': 1,
    '21CPL17': 1,

    // 2021 Scheme: Semester II (Physics and Chemistry Cycles)
    '21MAT21': 3,
    '21PHY22': 3,
    '21ELE23': 3,
    '21CIV24': 3,
    '21EGDL25': 3,
    '21PHYL26': 1,
    '21ELEL27': 1,
    '21EGH28': 2,
    '21IDT29': 1,
    '21SFH29': 1,
    '21CHE22': 3,
    '21PSP23': 3,
    '21ELN24': 3,
    '21EME25': 3,
    '21CHEL26': 1,
    '21CPL27': 1,

    // 2021 Scheme: Semester III
    '21MAT31': 3,
    '21CS32': 4,
    '21CS33': 4,
    '21CS34': 3,
    '21CSL35': 1,
    '21UH36': 1,
    '21KSK37': 1,
    '21KBK37': 1,
    '21CIP37': 1,
    '21CSL381': 1,
    '21CS382': 1,
    '21CS383': 1,
    '21CS384': 1,
    '21MATDIP31': 0,
    '21AI31': 4,
    '21AI32': 4,
    '21AI33': 3,
    '21AI34': 3,
    '21AIL35': 1,
    '21AIL381': 1,
    '21AIL382': 1,
    '21AIL383': 1,
    '21AIL384': 1,
    '21IS32': 4,
    '21IS33': 4,
    '21IS34': 3,
    '21ISL35': 1,
    '21ISL381': 1,
    '21ISL382': 1,
    '21ISL383': 1,
    '21ISL384': 1,
    '21AD32': 4,
    '21AD33': 4,
    '21AD34': 3,
    '21ADL35': 1,
    '21ADL381': 1,
    '21ADL382': 1,
    '21ADL383': 1,
    '21ADL384': 1,
    '21EC32': 4,
    '21EC33': 4,
    '21EC34': 3,
    '21ECL35': 1,
    '21ECL381': 1,
    '21ECL382': 1,
    '21ECL383': 1,
    '21ECL384': 1,
    '21ME32': 4,
    '21ME33': 4,
    '21ME34': 3,
    '21MEL35': 1,
    '21MEL381': 1,
    '21MEL382': 1,
    '21MEL383': 1,
    '21MEL384': 1,
    '21CV32': 4,
    '21CV33': 4,
    '21CV34': 3,
    '21CVL35': 1,
    '21CVL381': 1,
    '21CVL382': 1,
    '21CVL383': 1,
    '21CVL384': 1,

    // 2021 Scheme: Semester IV
    '21MAT41': 3,
    '21MATCS41': 3,
    '21CS41': 3,
    '21CS42': 4,
    '21CS43': 4,
    '21CS44': 3,
    '21BE45': 2,
    '21CSL46': 1,
    '21KSK47': 1,
    '21KBK47': 1,
    '21CIP47': 1,
    '21CSL481': 1,
    '21CS482': 1,
    '21CSL483': 1,
    '21CS484': 1,
    '21UH49': 1,
    '21INT49': 2,
    '21MATDIP41': 0,
    '21AI41': 4,
    '21AI42': 4,
    '21AI43': 3,
    '21AIL44': 1,
    '21AIL481': 1,
    '21AIL482': 1,
    '21AIL483': 1,
    '21AIL484': 1,
    '21IS41': 4,
    '21IS42': 4,
    '21IS43': 3,
    '21ISL44': 1,
    '21ISL481': 1,
    '21ISL482': 1,
    '21ISL483': 1,
    '21ISL484': 1,
    '21AD41': 4,
    '21AD42': 4,
    '21AD43': 3,
    '21ADL44': 1,
    '21ADL481': 1,
    '21ADL482': 1,
    '21ADL483': 1,
    '21ADL484': 1,
    '21EC41': 3,
    '21EC42': 4,
    '21EC43': 4,
    '21ECL44': 1,
    '21ECL481': 1,
    '21ECL482': 1,
    '21ECL483': 1,
    '21ECL484': 1,
    '21ME41': 4,
    '21ME42': 4,
    '21ME43': 3,
    '21MEL44': 1,
    '21MEL481': 1,
    '21MEL482': 1,
    '21MEL483': 1,
    '21MEL484': 1,
    '21CV41': 4,
    '21CV42': 4,
    '21CV43': 3,
    '21CVL44': 1,
    '21CVL481': 1,
    '21CVL482': 1,
    '21CVL483': 1,
    '21CVL484': 1,

    // 2021 Scheme: Semester V
    '21CS51': 3,
    '21CS52': 4,
    '21CS53': 3,
    '21CS54': 3,
    '21CSL55': 1,
    '21RMI56': 2,
    '21CIV57': 1,
    '21CSL581': 1,
    '21CSL582': 1,
    '21CSL583': 1,
    '21CSL584': 1,
    '21AI51': 3,
    '21AI52': 4,
    '21AI53': 3,
    '21AI54': 3,
    '21AIL55': 1,
    '21AIL581': 1,
    '21AIL582': 1,
    '21AIL583': 1,
    '21AIL584': 1,
    '21IS51': 3,
    '21IS52': 4,
    '21IS53': 3,
    '21IS54': 3,
    '21ISL55': 1,
    '21ISL581': 1,
    '21ISL582': 1,
    '21ISL583': 1,
    '21ISL584': 1,
    '21AD51': 3,
    '21AD52': 4,
    '21AD53': 3,
    '21AD54': 3,
    '21ADL55': 1,
    '21ADL581': 1,
    '21ADL582': 1,
    '21ADL583': 1,
    '21ADL584': 1,
    '21EC51': 3,
    '21EC52': 4,
    '21EC53': 3,
    '21EC54': 3,
    '21ECL55': 1,
    '21ECL581': 1,
    '21ECL582': 1,
    '21ECL583': 1,
    '21ECL584': 1,
    '21ME51': 3,
    '21ME52': 4,
    '21ME53': 3,
    '21ME54': 3,
    '21MEL55': 1,
    '21MEL581': 1,
    '21MEL582': 1,
    '21MEL583': 1,
    '21MEL584': 1,
    '21CV51': 3,
    '21CV52': 4,
    '21CV53': 3,
    '21CV54': 3,
    '21CVL55': 1,
    '21CVL581': 1,
    '21CVL582': 1,
    '21CVL583': 1,
    '21CVL584': 1,

    // 2021 Scheme: Semester VI
    '21CS61': 3,
    '21CS62': 4,
    '21CS63': 3,
    '21CS641': 3,
    '21CS642': 3,
    '21CS643': 3,
    '21CS644': 3,
    '21CS651': 3,
    '21CS652': 3,
    '21CS653': 3,
    '21CS654': 3,
    '21CS655': 3,
    '21CS656': 3,
    '21CSL66': 1,
    '21CSMP67': 2,
    '21INT68': 3,
    '21AI61': 3,
    '21AI62': 4,
    '21AI63': 3,
    '21AI641': 3,
    '21AI642': 3,
    '21AI643': 3,
    '21AI644': 3,
    '21AI651': 3,
    '21AI652': 3,
    '21AI653': 3,
    '21AI654': 3,
    '21AIL66': 1,
    '21AIMP67': 2,
    '21IS61': 3,
    '21IS62': 4,
    '21IS63': 3,
    '21IS641': 3,
    '21IS642': 3,
    '21IS643': 3,
    '21IS644': 3,
    '21IS651': 3,
    '21IS652': 3,
    '21IS653': 3,
    '21IS654': 3,
    '21ISL66': 1,
    '21ISMP67': 2,
    '21AD61': 3,
    '21AD62': 4,
    '21AD63': 3,
    '21AD641': 3,
    '21AD642': 3,
    '21AD643': 3,
    '21AD644': 3,
    '21AD651': 3,
    '21AD652': 3,
    '21AD653': 3,
    '21AD654': 3,
    '21ADL66': 1,
    '21ADMP67': 2,
    '21EC61': 3,
    '21EC62': 4,
    '21EC63': 3,
    '21EC641': 3,
    '21EC642': 3,
    '21EC643': 3,
    '21EC644': 3,
    '21EC651': 3,
    '21EC652': 3,
    '21EC653': 3,
    '21EC654': 3,
    '21ECL66': 1,
    '21ECMP67': 2,
    '21ME61': 3,
    '21ME62': 4,
    '21ME63': 3,
    '21ME641': 3,
    '21ME642': 3,
    '21ME643': 3,
    '21ME644': 3,
    '21ME651': 3,
    '21ME652': 3,
    '21ME653': 3,
    '21ME654': 3,
    '21MEL66': 1,
    '21MEMP67': 2,
    '21CV61': 3,
    '21CV62': 4,
    '21CV63': 3,
    '21CV641': 3,
    '21CV642': 3,
    '21CV643': 3,
    '21CV644': 3,
    '21CV651': 3,
    '21CV652': 3,
    '21CV653': 3,
    '21CV654': 3,
    '21CVL66': 1,
    '21CVMP67': 2,

    // 2021 Scheme: Semester VII
    '21CS71': 3,
    '21CS72': 2,
    '21CS731': 3,
    '21CS732': 3,
    '21CS733': 3,
    '21CS734': 3,
    '21CS735': 3,
    '21CS741': 3,
    '21CS742': 3,
    '21CS743': 3,
    '21CS744': 3,
    '21CS745': 3,
    '21CS751': 3,
    '21CS752': 3,
    '21CS753': 3,
    '21CS754': 3,
    '21CS755': 3,
    '21CSP76': 10,
    '21AI71': 3,
    '21AI72': 2,
    '21AI731': 3,
    '21AI732': 3,
    '21AI733': 3,
    '21AI734': 3,
    '21AI735': 3,
    '21AI741': 3,
    '21AI742': 3,
    '21AI743': 3,
    '21AI744': 3,
    '21AI745': 3,
    '21AI751': 3,
    '21AI752': 3,
    '21AI753': 3,
    '21AI754': 3,
    '21AIP76': 10,
    '21IS71': 3,
    '21IS72': 2,
    '21IS731': 3,
    '21IS732': 3,
    '21IS733': 3,
    '21IS734': 3,
    '21IS735': 3,
    '21IS741': 3,
    '21IS742': 3,
    '21IS743': 3,
    '21IS744': 3,
    '21IS745': 3,
    '21IS751': 3,
    '21IS752': 3,
    '21IS753': 3,
    '21IS754': 3,
    '21ISP76': 10,
    '21AD71': 3,
    '21AD72': 2,
    '21AD731': 3,
    '21AD732': 3,
    '21AD733': 3,
    '21AD734': 3,
    '21AD735': 3,
    '21AD741': 3,
    '21AD742': 3,
    '21AD743': 3,
    '21AD744': 3,
    '21AD745': 3,
    '21AD751': 3,
    '21AD752': 3,
    '21AD753': 3,
    '21AD754': 3,
    '21ADP76': 10,
    '21EC71': 3,
    '21EC72': 2,
    '21EC731': 3,
    '21EC732': 3,
    '21EC733': 3,
    '21EC734': 3,
    '21EC735': 3,
    '21EC741': 3,
    '21EC742': 3,
    '21EC743': 3,
    '21EC744': 3,
    '21EC745': 3,
    '21EC751': 3,
    '21EC752': 3,
    '21EC753': 3,
    '21EC754': 3,
    '21ECP76': 10,
    '21ME71': 3,
    '21ME72': 2,
    '21ME731': 3,
    '21ME732': 3,
    '21ME733': 3,
    '21ME734': 3,
    '21ME735': 3,
    '21ME741': 3,
    '21ME742': 3,
    '21ME743': 3,
    '21ME744': 3,
    '21ME745': 3,
    '21ME751': 3,
    '21ME752': 3,
    '21ME753': 3,
    '21ME754': 3,
    '21MEP76': 10,
    '21CV71': 3,
    '21CV72': 2,
    '21CV731': 3,
    '21CV732': 3,
    '21CV733': 3,
    '21CV734': 3,
    '21CV735': 3,
    '21CV741': 3,
    '21CV742': 3,
    '21CV743': 3,
    '21CV744': 3,
    '21CV745': 3,
    '21CV751': 3,
    '21CV752': 3,
    '21CV753': 3,
    '21CV754': 3,
    '21CVP76': 10,

    // 2021 Scheme: Semester VIII
    '21CS81': 1,
    '21INT82': 15,
    '21INT822': 15,
    '21NS83': 0,
    '21PE83': 0,
    '21YO83': 0,
    '21AI81': 1,
    '21IS81': 1,
    '21AD81': 1,
    '21EC81': 1,
    '21ME81': 1,
    '21CV81': 1,

    // 2021 Scheme: Additional Codes
    '21SCR36': 1,
    '21XX56': 2,
    '21CS66X': 1,
    '21CS665': 2,
    '21CS655': 3,
    '21CS656': 3,
    '21CS661': 3,
    '21CS662': 3,
    '21CSL74': 1,
    '21CS76X': 2,
    '21CS821': 3,
    '21CS822': 3,
    '21CS831': 3,
    '21CS82': 8,
    '21CS83': 3,

    // 2022 Scheme: Semester I
    'BMATS101': 4,
    'BPHYS102': 4,
    'BCHES102': 4,
    'BPOPS103': 3,
    'BPCKS103': 3,
    'BESCK104A': 3,
    'BESCK104B': 3,
    'BESCK104C': 3,
    'BESCK104D': 3,
    'BESCK104E': 3,
    'BETCK105A': 3,
    'BETCK105B': 3,
    'BETCK105C': 3,
    'BETCK105D': 3,
    'BETCK105E': 3,
    'BETCK105F': 3,
    'BETCK105G': 3,
    'BETCK105H': 3,
    'BETCK105I': 3,
    'BETCK105J': 3,
    'BPLCK105A': 3,
    'BPLCK105B': 3,
    'BPLCK105C': 3,
    'BPLCK105D': 3,
    'BENGK106': 1,
    'BICOK107': 1,
    'BPWSK106': 1,
    'BKSKK107': 1,
    'BKBKK107': 1,
    'BIDTK158': 1,
    'BSFK108': 1,
    'BPHYL152': 1,
    'BCHEL153': 1,
    'BPSCK154': 1,
    'BPCKL154': 1,

    // 2022 Scheme: Semester II
    'BMATS201': 4,
    'BPHYS202': 4,
    'BCHES202': 4,
    'BPOPS203': 3,
    'BPCKS203': 3,
    'BESCK204A': 3,
    'BESCK204B': 3,
    'BESCK204C': 3,
    'BESCK204D': 3,
    'BESCK204E': 3,
    'BETCK205A': 3,
    'BETCK205B': 3,
    'BETCK205C': 3,
    'BETCK205D': 3,
    'BETCK205E': 3,
    'BETCK205F': 3,
    'BETCK205G': 3,
    'BETCK205H': 3,
    'BETCK205I': 3,
    'BETCK205J': 3,
    'BPLCK205A': 3,
    'BPLCK205B': 3,
    'BPLCK205C': 3,
    'BPLCK205D': 3,
    'BENGK206': 1,
    'BINSK207': 1,
    'BPWSK206': 1,
    'BKSKK207': 1,
    'BKBKK207': 1,
    'BIDTK258': 1,
    'BSFK208': 1,
    'BPHYL253': 1,
    'BCHEL252': 1,
    'BPSCK254': 1,
    'BPCKL254': 1,

    // 2022 Scheme: Semester III
    'BMATS301': 4,
    'BMATEC301': 3,
    'BCS301': 4,
    'BCS302': 4,
    'BCS303': 4,
    'BCS304': 3,
    'BCSL305': 1,
    'BCSL306': 1,
    'BCS306A': 3,
    'BCS306B': 3,
    'BCS306C': 3,
    'BCS306D': 3,
    'BCS358A': 1,
    'BCS358B': 1,
    'BCS358C': 1,
    'BCS358D': 1,
    'BSCK307': 1,
    'BNSK359': 0,
    'BPEK359': 0,
    'BYOK359': 0,
    'BMATDIP301': 0,
    'BAI301': 4,
    'BAI302': 4,
    'BAI303': 4,
    'BAI304': 3,
    'BAIL305': 1,
    'BAIL306': 1,
    'BAI306A': 3,
    'BAI306B': 3,
    'BAI306C': 3,
    'BAI306D': 3,
    'BAI358A': 1,
    'BAI358B': 1,
    'BAI358C': 1,
    'BAI358D': 1,
    'BIS301': 4,
    'BIS302': 4,
    'BIS303': 4,
    'BIS304': 3,
    'BISL305': 1,
    'BISL306': 1,
    'BIS306A': 3,
    'BIS306B': 3,
    'BIS306C': 3,
    'BIS306D': 3,
    'BIS358A': 1,
    'BIS358B': 1,
    'BIS358C': 1,
    'BIS358D': 1,
    'BAD301': 4,
    'BAD302': 4,
    'BAD303': 4,
    'BAD304': 3,
    'BADL305': 1,
    'BADL306': 1,
    'BAD306A': 3,
    'BAD306B': 3,
    'BAD306C': 3,
    'BAD306D': 3,
    'BAD358A': 1,
    'BAD358B': 1,
    'BAD358C': 1,
    'BAD358D': 1,
    'BEC301': 4,
    'BEC302': 4,
    'BEC303': 4,
    'BEC304': 3,
    'BECL305': 1,
    'BECL306': 1,
    'BEC306A': 3,
    'BEC306B': 3,
    'BEC306C': 3,
    'BEC306D': 3,
    'BEC358A': 1,
    'BEC358B': 1,
    'BEC358C': 1,
    'BEC358D': 1,
    'BME301': 4,
    'BME302': 4,
    'BME303': 4,
    'BME304': 3,
    'BMEL305': 1,
    'BMEL306': 1,
    'BME306A': 3,
    'BME306B': 3,
    'BME306C': 3,
    'BME306D': 3,
    'BME358A': 1,
    'BME358B': 1,
    'BME358C': 1,
    'BME358D': 1,
    'BCV301': 4,
    'BCV302': 4,
    'BCV303': 4,
    'BCV304': 3,
    'BCVL305': 1,
    'BCVL306': 1,
    'BCV306A': 3,
    'BCV306B': 3,
    'BCV306C': 3,
    'BCV306D': 3,
    'BCVL358A': 1,
    'BCVL358B': 1,
    'BCVL358C': 1,
    'BCVL358D': 1,

    // 2022 Scheme: Semester IV
    'BCS401': 4,
    'BCS402': 4,
    'BCS403': 4,
    'BCS404': 3,
    'BCSL405': 1,
    'BCSL406': 1,
    'BCS405A': 3,
    'BCS405B': 3,
    'BCS405C': 3,
    'BCS405D': 3,
    'BCS456A': 1,
    'BCS456B': 1,
    'BCS456C': 1,
    'BCS456D': 1,
    'BCIV407': 1,
    'BUHK408': 1,
    'BBOK407': 3,
    'BINT409': 2,
    'BMATDIP401': 0,
    'BAI401': 4,
    'BAI402': 4,
    'BAI403': 4,
    'BAI404': 3,
    'BAIL405': 1,
    'BAIL406': 1,
    'BAI405A': 3,
    'BAI405B': 3,
    'BAI405C': 3,
    'BAI405D': 3,
    'BAI456A': 1,
    'BAI456B': 1,
    'BAI456C': 1,
    'BAI456D': 1,
    'BIS401': 4,
    'BIS402': 4,
    'BIS403': 4,
    'BIS404': 3,
    'BISL405': 1,
    'BISL406': 1,
    'BIS405A': 3,
    'BIS405B': 3,
    'BIS405C': 3,
    'BIS405D': 3,
    'BIS456A': 1,
    'BIS456B': 1,
    'BIS456C': 1,
    'BIS456D': 1,
    'BAD401': 4,
    'BAD402': 4,
    'BAD403': 4,
    'BAD404': 3,
    'BADL405': 1,
    'BADL406': 1,
    'BAD405A': 3,
    'BAD405B': 3,
    'BAD405C': 3,
    'BAD405D': 3,
    'BAD456A': 1,
    'BAD456B': 1,
    'BAD456C': 1,
    'BAD456D': 1,
    'BEC401': 4,
    'BEC402': 4,
    'BEC403': 4,
    'BEC404': 3,
    'BECL405': 1,
    'BECL406': 1,
    'BEC405A': 3,
    'BEC405B': 3,
    'BEC405C': 3,
    'BEC405D': 3,
    'BEC456A': 1,
    'BEC456B': 1,
    'BEC456C': 1,
    'BEC456D': 1,
    'BME401': 4,
    'BME402': 4,
    'BME403': 4,
    'BME404': 3,
    'BMEL405': 1,
    'BMEL406': 1,
    'BME405A': 3,
    'BME405B': 3,
    'BME405C': 3,
    'BME405D': 3,
    'BME456A': 1,
    'BME456B': 1,
    'BME456C': 1,
    'BME456D': 1,
    'BCV401': 4,
    'BCV402': 4,
    'BCV403': 4,
    'BCV404': 3,
    'BCVL405': 1,
    'BCVL406': 1,
    'BCV405A': 3,
    'BCV405B': 3,
    'BCV405C': 3,
    'BCV405D': 3,
    'BCVL456A': 1,
    'BCVL456B': 1,
    'BCVL456C': 1,
    'BCVL456D': 1,

    // 2022 Scheme: Semester V
    'BCS501': 3,
    'BCS502': 4,
    'BCS503': 3,
    'BCS504': 3,
    'BCSL505': 1,
    'BRMI506': 2,
    'BCIV507': 1,
    'BCSL508': 1,
    'BCS508A': 1,
    'BCS508B': 1,
    'BCS508C': 1,
    'BCS508D': 1,
    'BAI501': 3,
    'BAI502': 4,
    'BAI503': 3,
    'BAI504': 3,
    'BAIL505': 1,
    'BAIL508': 1,
    'BAI508A': 1,
    'BAI508B': 1,
    'BAI508C': 1,
    'BAI508D': 1,
    'BIS501': 3,
    'BIS502': 4,
    'BIS503': 3,
    'BIS504': 3,
    'BISL505': 1,
    'BISL508': 1,
    'BIS508A': 1,
    'BIS508B': 1,
    'BIS508C': 1,
    'BIS508D': 1,
    'BAD501': 3,
    'BAD502': 4,
    'BAD503': 3,
    'BAD504': 3,
    'BADL505': 1,
    'BADL508': 1,
    'BAD508A': 1,
    'BAD508B': 1,
    'BAD508C': 1,
    'BAD508D': 1,
    'BEC501': 3,
    'BEC502': 4,
    'BEC503': 3,
    'BEC504': 3,
    'BECL505': 1,
    'BECL508': 1,
    'BEC508A': 1,
    'BEC508B': 1,
    'BEC508C': 1,
    'BEC508D': 1,
    'BME501': 3,
    'BME502': 4,
    'BME503': 3,
    'BME504': 3,
    'BMEL505': 1,
    'BMEL508': 1,
    'BME508A': 1,
    'BME508B': 1,
    'BME508C': 1,
    'BME508D': 1,
    'BCV501': 3,
    'BCV502': 4,
    'BCV503': 3,
    'BCV504': 3,
    'BCVL505': 1,
    'BCVL508': 1,
    'BCV508A': 1,
    'BCV508B': 1,
    'BCV508C': 1,
    'BCV508D': 1,

    // 2022 Scheme: Semester VI
    'BCS601': 3,
    'BCS602': 4,
    'BCS603': 3,
    'BCS604': 3,
    'BCS651': 3,
    'BCSL606': 1,
    'BCSMP607': 2,
    'BINT608': 3,
    'BAI601': 3,
    'BAI602': 4,
    'BAI603': 3,
    'BAI604': 3,
    'BAI651': 3,
    'BAIL606': 1,
    'BAIMP607': 2,
    'BIS601': 3,
    'BIS602': 4,
    'BIS603': 3,
    'BIS604': 3,
    'BIS651': 3,
    'BISL606': 1,
    'BISMP607': 2,
    'BAD601': 3,
    'BAD602': 4,
    'BAD603': 3,
    'BAD604': 3,
    'BAD651': 3,
    'BADL606': 1,
    'BADMP607': 2,
    'BEC601': 3,
    'BEC602': 4,
    'BEC603': 3,
    'BEC604': 3,
    'BEC651': 3,
    'BECL606': 1,
    'BECMP607': 2,
    'BME601': 3,
    'BME602': 4,
    'BME603': 3,
    'BME604': 3,
    'BME651': 3,
    'BMEL606': 1,
    'BMEMP607': 2,
    'BCV601': 3,
    'BCV602': 4,
    'BCV603': 3,
    'BCV604': 3,
    'BCV651': 3,
    'BCVL606': 1,
    'BCVMP607': 2,

    // 2022 Scheme: Semester VII
    'BCS701': 3,
    'BCS702': 2,
    'BCS703': 3,
    'BCS704': 3,
    'BCS714A': 3,
    'BCS714B': 3,
    'BCS714C': 3,
    'BCS714D': 3,
    'BCS751': 3,
    'BCS755A': 3,
    'BCS755B': 3,
    'BCS755C': 3,
    'BCS755D': 3,
    'BCSP706': 10,
    'BAI701': 3,
    'BAI702': 2,
    'BAI703': 3,
    'BAI704': 3,
    'BAI714A': 3,
    'BAI714B': 3,
    'BAI714C': 3,
    'BAI714D': 3,
    'BAI751': 3,
    'BAI755A': 3,
    'BAI755B': 3,
    'BAI755C': 3,
    'BAI755D': 3,
    'BAIP706': 10,
    'BIS701': 3,
    'BIS702': 2,
    'BIS703': 3,
    'BIS704': 3,
    'BIS714A': 3,
    'BIS714B': 3,
    'BIS714C': 3,
    'BIS714D': 3,
    'BIS751': 3,
    'BIS755A': 3,
    'BIS755B': 3,
    'BIS755C': 3,
    'BIS755D': 3,
    'BISP706': 10,
    'BAD701': 3,
    'BAD702': 2,
    'BAD703': 3,
    'BAD704': 3,
    'BAD714A': 3,
    'BAD714B': 3,
    'BAD714C': 3,
    'BAD714D': 3,
    'BAD751': 3,
    'BAD755A': 3,
    'BAD755B': 3,
    'BAD755C': 3,
    'BAD755D': 3,
    'BADP706': 10,
    'BEC701': 3,
    'BEC702': 2,
    'BEC703': 3,
    'BEC704': 3,
    'BEC714A': 3,
    'BEC714B': 3,
    'BEC714C': 3,
    'BEC714D': 3,
    'BEC751': 3,
    'BEC755A': 3,
    'BEC755B': 3,
    'BEC755C': 3,
    'BEC755D': 3,
    'BECP706': 10,
    'BME701': 3,
    'BME702': 2,
    'BME703': 3,
    'BME704': 3,
    'BME714A': 3,
    'BME714B': 3,
    'BME714C': 3,
    'BME714D': 3,
    'BME751': 3,
    'BME755A': 3,
    'BME755B': 3,
    'BME755C': 3,
    'BME755D': 3,
    'BMEP706': 10,
    'BCV701': 3,
    'BCV702': 2,
    'BCV703': 3,
    'BCV704': 3,
    'BCV714A': 3,
    'BCV714B': 3,
    'BCV714C': 3,
    'BCV714D': 3,
    'BCV751': 3,
    'BCV755A': 3,
    'BCV755B': 3,
    'BCV755C': 3,
    'BCV755D': 3,
    'BCVP706': 10,

    // 2022 Scheme: Semester VIII
    'BCS801': 1,
    'BCS786': 6,
    'BCS811A': 3,
    'BCS811B': 3,
    'BCS811C': 3,
    'BCS811D': 3,
    'BCS812A': 3,
    'BCS812B': 3,
    'BCS812C': 3,
    'BCS812D': 3,
    'BCS883': 10,
    'BINT802': 15,
    'BNSK859': 0,
    'BPEK859': 0,
    'BYOK859': 0,
    'BAI801': 1,
    'BAI786': 6,
    'BAI811A': 3,
    'BAI811B': 3,
    'BAI811C': 3,
    'BAI811D': 3,
    'BAI812A': 3,
    'BAI812B': 3,
    'BAI812C': 3,
    'BAI812D': 3,
    'BAI883': 10,
    'BIS801': 1,
    'BIS786': 6,
    'BIS811A': 3,
    'BIS811B': 3,
    'BIS811C': 3,
    'BIS811D': 3,
    'BIS812A': 3,
    'BIS812B': 3,
    'BIS812C': 3,
    'BIS812D': 3,
    'BIS883': 10,
    'BAD801': 1,
    'BAD786': 6,
    'BAD811A': 3,
    'BAD811B': 3,
    'BAD811C': 3,
    'BAD811D': 3,
    'BAD812A': 3,
    'BAD812B': 3,
    'BAD812C': 3,
    'BAD812D': 3,
    'BAD883': 10,
    'BEC801': 1,
    'BEC786': 6,
    'BEC811A': 3,
    'BEC811B': 3,
    'BEC811C': 3,
    'BEC811D': 3,
    'BEC812A': 3,
    'BEC812B': 3,
    'BEC812C': 3,
    'BEC812D': 3,
    'BEC883': 10,
    'BME801': 1,
    'BME786': 6,
    'BME811A': 3,
    'BME811B': 3,
    'BME811C': 3,
    'BME811D': 3,
    'BME812A': 3,
    'BME812B': 3,
    'BME812C': 3,
    'BME812D': 3,
    'BME883': 10,
    'BCV801': 1,
    'BCV786': 6,
    'BCV811A': 3,
    'BCV811B': 3,
    'BCV811C': 3,
    'BCV811D': 3,
    'BCV812A': 3,
    'BCV812B': 3,
    'BCV812C': 3,
    'BCV812D': 3,
    'BCV883': 10
  };
  return creditsMap[subjectCode] || 0;
}


async function calculateSgpa(excelPath, userId) {
  // Ensure the path is a string and valid
  if (typeof excelPath !== 'string') {
    throw new TypeError('The "path" argument must be of type string.');
  }
  const workbook = new ExcelJS.Workbook();
  await workbook.xlsx.readFile(excelPath);
  const sheet = workbook.worksheets[0];

  let totalPoints = 0;
  let totalCredits = 0;

  sheet.eachRow({ includeEmpty: false }, (row, rowNumber) => {
    if (rowNumber > 1) {
      const subjectCode = row.getCell(1).value;
      const subjectName = row.getCell(2).value;
      let internalMarks = row.getCell(3).value;
      let externalMarks = row.getCell(4).value;

      internalMarks = cleanData(internalMarks);
      externalMarks = cleanData(externalMarks);

      const totalMarks = internalMarks + externalMarks;
      const gradePoints = convertToGradePoints(totalMarks);
      const credits = getCreditsForSubject(subjectCode);

      totalPoints += gradePoints * credits;
      totalCredits += credits;

      saveMarksToDb(userId, subjectCode, subjectName, internalMarks, externalMarks, gradePoints, credits);
    }
  });

  const sgpa = totalCredits > 0 ? totalPoints / totalCredits : 0;
  await saveSgpaToDb(userId, sgpa.toFixed(2)); // Ensure only two decimal points

  return sgpa.toFixed(2);
}

async function saveMarksToDb(userId, subjectCode, subjectName, internalMarks, externalMarks, gradePoints, credits) {
  if (!userId) return; // Prevent saving if public
  await pool.query(
    'INSERT INTO marks (user_id, subject_code, subject_name, internal_marks, external_marks, total, sgpa, credits) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)',
    [userId, subjectCode, subjectName, internalMarks, externalMarks, internalMarks + externalMarks, gradePoints, credits]
  );
}

async function calculateCgpa(userId) {
  const result = await pool.query('SELECT sgpa, credits FROM marks WHERE user_id = $1', [userId]);
  const sGpaCredits = result.rows.map(row => ({
    sgpa: row.sgpa,
    credits: row.credits,
  }));
  
  let totalSgpaPoints = 0;
  let totalCredits = 0;

  sGpaCredits.forEach(item => {
    totalSgpaPoints += item.sgpa * item.credits;
    totalCredits += item.credits;
  });

  const cgpa = totalCredits > 0 ? totalSgpaPoints / totalCredits : 0;
  return cgpa.toFixed(2); // Ensure only two decimal points
}

async function saveSgpaToDb(userId, sgpa) {
  if (!userId) return; // Skip DB update if public
  await pool.query('UPDATE users SET sgpa = $1 WHERE user_id = $2', [sgpa, userId]);
}

module.exports = {
  calculateSgpa,
  calculateCgpa,
  saveSgpaToDb,
};